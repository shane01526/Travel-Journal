<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨è¼¯æ—¥èªŒ - æ—…è¡Œæ—¥èªŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap');
        
        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        .photo-editor-container {
            position: relative;
            width: 100%;
            height: 500px;
            overflow: hidden;
            background: #f5f5f4;
            border-radius: 16px;
            cursor: move;
            border: 2px solid #e7e5e4;
        }
        
        .photo-editor-image {
            position: absolute;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
        
        .btn-mode {
            transition: all 0.3s ease;
        }
        
        .btn-mode.active {
            background: linear-gradient(135deg, #2c5f2d 0%, #3d7f3f 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(44, 95, 45, 0.3);
        }
    </style>
</head>
<body class="bg-stone-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-stone-200">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    <span class="text-xl font-serif text-slate-800">æ—…è¡Œæ—¥èªŒ</span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="text-slate-600 hover:text-emerald-700 text-sm transition-colors">è¿”å›æ›¸æ«ƒ</a>
                    <a href="/logout" class="text-slate-500 hover:text-slate-700 text-sm transition-colors">ç™»å‡º</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Editor Toolbar -->
    <div class="bg-white border-b border-stone-200 sticky top-16 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-2">
                    <button id="btnSplit" onclick="setMode('split')" class="btn-mode active px-5 py-2.5 rounded-xl flex items-center gap-2 text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                        </svg>
                        <span class="hidden sm:inline">æ›¸é å¼</span>
                    </button>
                    <button id="btnText" onclick="setMode('text')" class="btn-mode px-5 py-2.5 rounded-xl flex items-center gap-2 text-sm font-medium text-slate-600 hover:bg-stone-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="hidden sm:inline">ç´”æ–‡å­—</span>
                    </button>
                    <button id="btnPhoto" onclick="setMode('photo')" class="btn-mode px-5 py-2.5 rounded-xl flex items-center gap-2 text-sm font-medium text-slate-600 hover:bg-stone-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="hidden sm:inline">åœ–ç‰‡ç·¨è¼¯</span>
                    </button>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="deleteJournal()" class="px-6 py-2.5 border-2 border-red-300 text-red-600 rounded-full hover:bg-red-50 transition-colors text-sm font-medium">
                        åˆªé™¤
                    </button>
                    <button id="submitBtn" onclick="saveJournal()" class="px-8 py-2.5 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-full hover:shadow-lg transition-all flex items-center gap-2 text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        æ›´æ–°æ—¥èªŒ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="successMessage" class="hidden fixed top-24 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 bg-emerald-500 text-white rounded-2xl shadow-2xl flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="font-medium">æ—¥èªŒæ›´æ–°æˆåŠŸï¼æ­£åœ¨è¿”å›...</span>
    </div>
    <div id="errorMessage" class="hidden fixed top-24 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 bg-red-500 text-white rounded-2xl shadow-2xl flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span id="errorText" class="font-medium"></span>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-10">
        <!-- Title Input -->
        <input 
            id="title"
            type="text"
            value="{{ journal.location }}"
            placeholder="è¼¸å…¥ä½ çš„æ•…äº‹æ¨™é¡Œ..."
            class="w-full text-4xl md:text-5xl font-serif text-slate-800 border-none outline-none bg-transparent mb-8 placeholder-stone-400"
        />

        <!-- Meta Information -->
        <div class="flex flex-wrap gap-4 mb-10">
            <div class="flex items-center gap-2 bg-white px-4 py-3 rounded-xl border border-stone-200 shadow-sm">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <input id="date" type="date" value="{{ journal.date }}" class="outline-none text-slate-700" />
            </div>
            <div class="flex items-center gap-2 bg-white px-4 py-3 rounded-xl border border-stone-200 shadow-sm">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <input id="location" type="text" value="{{ journal.location }}" placeholder="åœ°é»" class="outline-none text-slate-700 w-40" />
            </div>
            <div class="flex items-center gap-2 bg-white px-4 py-3 rounded-xl border border-stone-200 shadow-sm">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <input id="country" type="text" value="{{ journal.country }}" placeholder="åœ‹å®¶" class="outline-none text-slate-700 w-32" />
            </div>
        </div>

        <!-- Split Mode: Book-style Editor -->
        <div id="splitMode" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-stone-200">
            <div class="grid md:grid-cols-2 divide-x divide-stone-200">
                <!-- Left: Photo Section -->
                <div class="p-10 space-y-6 bg-stone-50">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-serif text-slate-800">ğŸ“¸ ç…§ç‰‡</h3>
                        <button id="removePhotoBtn" onclick="removePhoto()" class="{% if not journal.photo %}hidden{% endif %} text-red-500 hover:text-red-700 p-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)" />
                    
                    <!-- Upload Area -->
                    <div id="uploadArea" class="{% if journal.photo %}hidden{% endif %}">
                        <label for="photoInput" class="block aspect-[3/4] bg-stone-100 rounded-2xl border-2 border-dashed border-stone-300 cursor-pointer hover:border-emerald-500 transition-all group">
                            <div class="h-full flex flex-col items-center justify-center text-center p-8">
                                <svg class="w-20 h-20 text-stone-400 group-hover:text-emerald-600 mb-4 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <p class="text-slate-700 text-lg font-medium mb-2">é»æ“Šä¸Šå‚³ç…§ç‰‡</p>
                                <p class="text-stone-500 text-sm">æˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤å€åŸŸ</p>
                                <p class="text-stone-400 text-xs mt-2">æ”¯æ´ JPGã€PNGã€GIFï¼Œæœ€å¤§ 16MB</p>
                            </div>
                        </label>
                    </div>

                    <!-- Photo Editor -->
                    <div id="photoEditor" class="hidden space-y-4">
                        <div class="photo-editor-container" id="editorContainer">
                            <img id="editorImage" class="photo-editor-image" src="" alt="ç·¨è¼¯ç…§ç‰‡">
                        </div>
                        
                        <div class="space-y-4 bg-white p-5 rounded-xl border border-stone-200">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">ğŸ” ç¸®æ”¾å¤§å°</label>
                                <input type="range" id="scaleSlider" min="50" max="200" value="100" 
                                    class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer" 
                                    oninput="updateScale(this.value)">
                                <div class="flex justify-between text-xs text-slate-500 mt-2">
                                    <span>50%</span>
                                    <span id="scaleValue" class="font-medium text-emerald-700">100%</span>
                                    <span>200%</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2">
                                <button type="button" onclick="rotateImage(-90)" class="px-3 py-2 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors text-sm font-medium text-slate-700">
                                    â†¶ å·¦è½‰
                                </button>
                                <button type="button" onclick="rotateImage(90)" class="px-3 py-2 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors text-sm font-medium text-slate-700">
                                    â†· å³è½‰
                                </button>
                                <button type="button" onclick="resetPhotoTransform()" class="px-3 py-2 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors text-sm font-medium text-slate-700">
                                    ğŸ”„ é‡è¨­
                                </button>
                            </div>
                            
                            <p class="text-xs text-center text-slate-500">ğŸ’¡ æç¤ºï¼šå¯æ‹–æ›³ç…§ç‰‡èª¿æ•´ä½ç½®</p>
                            
                            <div class="flex gap-3 pt-2">
                                <button type="button" onclick="confirmPhoto()" class="flex-1 px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                                    âœ“ ç¢ºèªä½¿ç”¨
                                </button>
                                <button type="button" onclick="cancelPhotoEdit()" class="flex-1 px-4 py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl font-medium transition-colors">
                                    âœ• å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Photo Preview -->
                    <div id="photoPreview" class="{% if not journal.photo %}hidden{% endif %} space-y-3">
                        <img id="finalPreview" src="{% if journal.photo %}{{ journal.photo }}{% endif %}" alt="æœ€çµ‚é è¦½" class="w-full aspect-[3/4] object-cover rounded-2xl border-2 border-emerald-200 shadow-lg">
                        <button type="button" onclick="changePhoto()" class="w-full px-4 py-3 bg-white hover:bg-emerald-50 text-emerald-700 rounded-xl border-2 border-emerald-200 font-medium transition-colors">
                            æ›´æ›ç…§ç‰‡
                        </button>
                    </div>
                </div>

                <!-- Right: Text Section -->
                <div class="p-10 space-y-4">
                    <h3 class="text-xl font-serif text-slate-800 mb-4">âœï¸ æ•…äº‹</h3>
                    <textarea 
                        id="content"
                        placeholder="åœ¨é€™è£¡æ›¸å¯«ä½ çš„æ—…è¡Œæ•…äº‹..."
                        class="w-full h-[600px] p-6 border-2 border-stone-200 rounded-2xl resize-none focus:outline-none focus:border-emerald-500 font-serif text-slate-700 text-lg leading-relaxed transition-colors"
                    >{{ journal.content }}</textarea>
                    <div class="text-sm text-slate-500 text-right">
                        <span id="charCount">{{ journal.content|length }}</span> å­—
                    </div>
                </div>
            </div>
        </div>

        <!-- Text Mode -->
        <div id="textMode" class="hidden bg-white rounded-3xl shadow-2xl p-16 border border-stone-200">
            <textarea 
                id="contentText"
                placeholder="åœ¨é€™è£¡ç›¡æƒ…æ›¸å¯«ä½ çš„æ—…è¡Œæ•…äº‹..."
                class="w-full h-[700px] border-none resize-none focus:outline-none font-serif text-xl text-slate-700 leading-relaxed"
            >{{ journal.content }}</textarea>
        </div>

        <!-- Photo Mode -->
        <div id="photoMode" class="hidden bg-white rounded-3xl shadow-2xl p-12 border border-stone-200">
            <h3 class="text-2xl font-serif text-slate-800 mb-8">ğŸ“· ç…§ç‰‡ç•«å»Š</h3>
            <div class="text-center text-slate-500 py-20">
                æ­¤æ¨¡å¼é–‹ç™¼ä¸­...
            </div>
        </div>

        <!-- Coordinates Section -->
        <div class="mt-8 bg-white rounded-2xl p-8 shadow-lg border border-stone-200">
            <h3 class="text-xl font-serif text-slate-800 mb-6">ğŸ“ åœ°é»åº§æ¨™</h3>
            
            <div class="mb-6">
                <div class="flex gap-2">
                    <input id="searchLocation" type="text" placeholder="æœå°‹åœ°é»ï¼ˆä¾‹å¦‚ï¼šTokyo Towerï¼‰"
                        class="flex-1 px-4 py-3 rounded-xl bg-stone-50 border-2 border-stone-200 focus:outline-none focus:border-emerald-500 transition-colors" />
                    <button type="button" onclick="searchCoordinates()" 
                        class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl transition-colors font-medium shadow-md hover:shadow-lg">
                        æœå°‹
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-3">æˆ–ä½¿ç”¨ï¼š
                    <a href="https://www.latlong.net/" target="_blank" class="text-emerald-600 hover:underline">LatLong.net</a> | 
                    <a href="https://www.google.com/maps" target="_blank" class="text-emerald-600 hover:underline">Google Maps</a>
                </p>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ç·¯åº¦</label>
                    <input id="lat" type="number" step="any" value="{{ journal.lat }}"
                        class="w-full px-4 py-3 rounded-xl bg-stone-50 border-2 border-stone-200 focus:outline-none focus:border-emerald-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ç¶“åº¦</label>
                    <input id="lng" type="number" step="any" value="{{ journal.lng }}"
                        class="w-full px-4 py-3 rounded-xl bg-stone-50 border-2 border-stone-200 focus:outline-none focus:border-emerald-500" />
                </div>
            </div>

            <div id="map" class="w-full h-80 rounded-2xl border-2 border-stone-200"></div>
        </div>
    </div>

    <script>
        let photoBase64 = {% if journal.photo %}'{{ journal.photo }}'{% else %}null{% endif %};
        let photoChanged = false;
        let editorMode = 'split';
        let originalImage = null;
        let imageScale = 1;
        let imageRotation = 0;
        let imageX = 0;
        let imageY = 0;
        let isDragging = false;
        let startX, startY;
        const journalId = {{ journal.id }};

        // å­—æ•¸çµ±è¨ˆ
        function updateCharCount() {
            const content = document.getElementById('content').value;
            document.getElementById('charCount').textContent = content.length;
        }
        document.getElementById('content').addEventListener('input', updateCharCount);

        // æ¨¡å¼åˆ‡æ›
        function setMode(mode) {
            editorMode = mode;
            
            document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('splitMode').classList.add('hidden');
            document.getElementById('textMode').classList.add('hidden');
            document.getElementById('photoMode').classList.add('hidden');
            
            if (mode === 'split') {
                document.getElementById('splitMode').classList.remove('hidden');
                document.getElementById('btnSplit').classList.add('active');
            } else if (mode === 'text') {
                document.getElementById('textMode').classList.remove('hidden');
                document.getElementById('btnText').classList.add('active');
                document.getElementById('contentText').value = document.getElementById('content').value;
            } else if (mode === 'photo') {
                document.getElementById('photoMode').classList.remove('hidden');
                document.getElementById('btnPhoto').classList.add('active');
            }
        }

        // ç…§ç‰‡åŠŸèƒ½
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 16 * 1024 * 1024) {
                showError('æª”æ¡ˆå¤ªå¤§ï¼è«‹é¸æ“‡å°æ–¼ 16MB çš„ç…§ç‰‡');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage = e.target.result;
                showPhotoEditor();
            };
            reader.readAsDataURL(file);
        }

        function showPhotoEditor() {
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('photoEditor').classList.remove('hidden');
            
            const img = document.getElementById('editorImage');
            img.src = originalImage;
            img.onload = function() {
                resetPhotoTransform();
                initDragAndDrop();
            };
        }

        function initDragAndDrop() {
            const container = document.getElementById('editorContainer');
            
            container.onmousedown = startDrag;
            document.onmousemove = drag;
            document.onmouseup = stopDrag;
            
            container.ontouchstart = function(e) {
                startDrag(e.touches[0]);
            };
            document.ontouchmove = function(e) {
                drag(e.touches[0]);
                e.preventDefault();
            };
            document.ontouchend = stopDrag;
            
            function startDrag(e) {
                isDragging = true;
                startX = e.clientX - imageX;
                startY = e.clientY - imageY;
                container.style.cursor = 'grabbing';
            }
            
            function drag(e) {
                if (!isDragging) return;
                imageX = e.clientX - startX;
                imageY = e.clientY - startY;
                updateImageTransform();
            }
            
            function stopDrag() {
                isDragging = false;
                container.style.cursor = 'move';
            }
        }

        function updateScale(value) {
            imageScale = value / 100;
            document.getElementById('scaleValue').textContent = value + '%';
            updateImageTransform();
        }

        function rotateImage(degrees) {
            imageRotation += degrees;
            updateImageTransform();
        }

        function updateImageTransform() {
            const img = document.getElementById('editorImage');
            img.style.transform = `translate(${imageX}px, ${imageY}px) scale(${imageScale}) rotate(${imageRotation}deg)`;
        }

        function resetPhotoTransform() {
            const container = document.getElementById('editorContainer');
            const img = document.getElementById('editorImage');
            
            imageScale = 1;
            imageRotation = 0;
            imageX = (container.offsetWidth - img.naturalWidth) / 2;
            imageY = (container.offsetHeight - img.naturalHeight) / 2;
            
            document.getElementById('scaleSlider').value = 100;
            document.getElementById('scaleValue').textContent = '100%';
            
            updateImageTransform();
        }

        function confirmPhoto() {
            const container = document.getElementById('editorContainer');
            const canvas = document.createElement('canvas');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = function() {
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.translate(imageX, imageY);
                ctx.scale(imageScale, imageScale);
                ctx.rotate(imageRotation * Math.PI / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();

                photoBase64 = canvas.toDataURL('image/jpeg', 0.9);
                photoChanged = true;
                showFinalPreview();
            };
            img.src = originalImage;
        }

        function showFinalPreview() {
            document.getElementById('photoEditor').classList.add('hidden');
            document.getElementById('photoPreview').classList.remove('hidden');
            document.getElementById('finalPreview').src = photoBase64;
            document.getElementById('removePhotoBtn').classList.remove('hidden');
        }

        function cancelPhotoEdit() {
            document.getElementById('photoInput').value = '';
            document.getElementById('photoEditor').classList.add('hidden');
            
            if (photoBase64) {
                document.getElementById('photoPreview').classList.remove('hidden');
            } else {
                document.getElementById('uploadArea').classList.remove('hidden');
            }
        }

        function changePhoto() {
            document.getElementById('photoInput').click();
        }

        function removePhoto() {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤ç…§ç‰‡å—ï¼Ÿ')) return;
            
            photoBase64 = null;
            photoChanged = true;
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('removePhotoBtn').classList.add('hidden');
        }

        // åœ°åœ–
        const initialLat = parseFloat('{{ journal.lat }}') || 25.0330;
        const initialLng = parseFloat('{{ journal.lng }}') || 121.5654;
        const map = L.map('map').setView([initialLat, initialLng], initialLat === 25.0330 ? 3 : 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let marker = null;

        if (initialLat !== 0 || initialLng !== 0) {
            marker = L.marker([initialLat, initialLng]).addTo(map);
        }

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            updateMarkerAndInputs(lat, lng);
        });

        function updateMarkerAndInputs(lat, lng) {
            document.getElementById('lat').value = lat.toFixed(6);
            document.getElementById('lng').value = lng.toFixed(6);
            if (marker) marker.remove();
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 13);
        }

        async function searchCoordinates() {
            const searchTerm = document.getElementById('searchLocation').value.trim();
            if (!searchTerm) {
                showError('è«‹è¼¸å…¥è¦æœå°‹çš„åœ°é»');
                return;
            }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    updateMarkerAndInputs(lat, lng);
                } else {
                    showError('æ‰¾ä¸åˆ°è©²åœ°é»');
                }
            } catch (error) {
                showError('æœå°‹å¤±æ•—');
            }
        }

        document.getElementById('searchLocation').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchCoordinates();
            }
        });

        // å„²å­˜æ—¥èªŒ
        async function saveJournal() {
            const data = {
                date: document.getElementById('date').value,
                location: document.getElementById('location').value,
                country: document.getElementById('country').value,
                lat: parseFloat(document.getElementById('lat').value) || 0,
                lng: parseFloat(document.getElementById('lng').value) || 0,
                content: editorMode === 'text' ? document.getElementById('contentText').value : document.getElementById('content').value
            };

            if (!data.location || !data.country || !data.content) {
                showError('è«‹å¡«å¯«åœ°é»ã€åœ‹å®¶å’Œå…§å®¹');
                return;
            }

            // åªåœ¨ç…§ç‰‡æœ‰è®Šæ›´æ™‚æ‰å‚³é€
            if (photoChanged) {
                data.photo = photoBase64;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg><span class="ml-2">æ›´æ–°ä¸­...</span>';

            try {
                const res = await fetch(`/api/journals/${journalId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();

                if (result.success) {
                    showSuccess();
                    setTimeout(() => window.location.href = '/dashboard', 1500);
                } else {
                    showError(result.message || 'æ›´æ–°å¤±æ•—');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span class="ml-2">æ›´æ–°æ—¥èªŒ</span>';
                }
            } catch (err) {
                console.error('æäº¤éŒ¯èª¤:', err);
                showError('ä¼ºæœå™¨éŒ¯èª¤');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span class="ml-2">æ›´æ–°æ—¥èªŒ</span>';
            }
        }

        // åˆªé™¤æ—¥èªŒ
        async function deleteJournal() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ—¥èªŒå—ï¼Ÿåˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚')) return;
            
            try {
                const response = await fetch(`/api/journals/${journalId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess();
                    setTimeout(() => window.location.href = '/dashboard', 1000);
                } else {
                    showError('åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('åˆªé™¤éŒ¯èª¤:', error);
                showError('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function showSuccess() {
            const msg = document.getElementById('successMessage');
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }

        function showError(message) {
            const msg = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>
